---
import Button from "./ui/Button.astro";

interface Props {
  id: string;
  title: string;
  closeText?: string;
  confirmText?: string;
  variant?: 'danger' | 'primary';
  size?: 'md' | 'lg' | 'xl';
  showActions?: boolean;
}

const {
  id,
  title,
  closeText = 'Cancel',
  confirmText = 'Confirm',
  variant = 'primary',
  size = 'md',
  showActions = true,
} = Astro.props;

const sizeClasses = {
  md: 'max-w-md',
  lg: 'max-w-2xl',
  xl: 'max-w-4xl',
};

const sizeClass = sizeClasses[size] || 'max-w-md';

const titleId = `${id}-title`;
---

<div id={id} class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center backdrop-blur-sm transition-opacity">
  <div
    class={`bg-admin-card border border-admin-border rounded-xl p-6 w-full mx-4 shadow-2xl transform transition-all scale-100 max-h-[85vh] overflow-y-auto ${sizeClass}`}
    role="dialog"
    aria-modal="true"
    aria-labelledby={titleId}
    tabindex="-1"
  >
    <div class="flex items-start justify-between gap-4 mb-4">
      <h3 id={titleId} class="text-xl font-bold">{title}</h3>
      <Button
        variant="ghost"
        size="sm"
        class="p-2 -mt-1 -mr-1 text-admin-muted hover:text-admin-text close-modal"
        aria-label="Close modal"
      >
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </Button>
    </div>
    
    <div class="text-admin-text mb-6">
      <slot />
    </div>

    {showActions && (
      <div class="flex gap-3 justify-end">
        <button type="button" class="btn btn-secondary close-modal" data-modal-cancel>{closeText}</button>
        <button 
          type="button" 
          class={`btn ${variant === 'danger' ? 'bg-red-500 hover:bg-red-600 text-white' : 'btn-primary'} confirm-modal`}
        >
          {confirmText}
        </button>
      </div>
    )}
  </div>
</div>

<script define:vars={{ id }}>
  const modal = document.getElementById(id);
  
  if (modal) {
    const dialog = modal.querySelector('[role="dialog"]');
    const focusableSelector = [
      'a[href]',
      'area[href]',
      'button:not([disabled])',
      'input:not([disabled]):not([type="hidden"])',
      'select:not([disabled])',
      'textarea:not([disabled])',
      'iframe',
      'object',
      'embed',
      '[contenteditable="true"]',
      '[tabindex]:not([tabindex="-1"])',
    ].join(',');
    let lastFocusedElement = null;

    function getFocusableElements() {
      return Array.from(modal.querySelectorAll(focusableSelector))
        .filter((el) => el instanceof HTMLElement && !el.hasAttribute('disabled') && el.offsetParent !== null);
    }

    function focusFirstElement() {
      const focusable = getFocusableElements();
      if (focusable.length > 0) {
        focusable[0].focus();
        return;
      }
      if (dialog && dialog instanceof HTMLElement) {
        dialog.focus();
      }
    }

    function handleKeydown(e) {
      if (e.key !== 'Tab' || modal.classList.contains('hidden')) {
        return;
      }

      const focusable = getFocusableElements();
      if (focusable.length === 0) {
        e.preventDefault();
        if (dialog && dialog instanceof HTMLElement) {
          dialog.focus();
        }
        return;
      }

      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      const active = document.activeElement;

      if (e.shiftKey && active === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && active === last) {
        e.preventDefault();
        first.focus();
      }
    }

    // Close on backdrop click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });

    // Close buttons
    modal.querySelectorAll('.close-modal').forEach(btn => {
      btn.addEventListener('click', closeModal);
    });

    // Confirm button
    modal.querySelectorAll('.confirm-modal').forEach(btn => {
      btn.addEventListener('click', () => {
        modal.dispatchEvent(new CustomEvent('confirm'));
      });
    });

    // ESC key to close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });

    function closeModal() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.style.overflow = '';
      if (lastFocusedElement && document.contains(lastFocusedElement)) {
        lastFocusedElement.focus();
      }
      modal.dispatchEvent(new CustomEvent('close'));
    }

    // Expose open function on the element for easier usage
    modal.open = () => {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';
        lastFocusedElement = document.activeElement instanceof HTMLElement ? document.activeElement : null;
        requestAnimationFrame(focusFirstElement);
    };
    
    modal.addEventListener('keydown', handleKeydown);
    modal.close = closeModal;
  }
</script>

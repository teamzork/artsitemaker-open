---
import fs from "fs";
import path from "path";
import { getSession, SESSION_COOKIE_NAME } from "../lib/auth";
import { isEmailAuthConfigured, validateSession } from "../lib/db-auth";
import { getAppMeta } from "../lib/app-config";
import { getRepoPath } from "../lib/paths";
import { getInitials } from "../lib/string-utils";
import Chevron from "./icons/Chevron.astro";

import {
  LayoutDashboard,
  Settings2,
  Settings,
  Image,
  FileText,
  Wrench,
  Rocket,
  Library,
} from "lucide-react";

interface Subsection {
  label: string;
  id: string;
  href?: string;
  disabled?: boolean;
  disabledReason?: string;
}

interface NavItem {
  label: string;
  href: string;
  icon: any; // Changed from string to any (component)
  subsections?: Subsection[];
}

interface Props {
  currentPath: string;
}

const { currentPath } = Astro.props;

// Get current user session (basic/github or email DB session)
const sessionCookie = Astro.cookies.get(SESSION_COOKIE_NAME)?.value;
const basicSession = getSession(Astro.cookies);

let sessionUser: { username: string; avatarUrl?: string | null; role?: string } | null = null;

if (basicSession) {
  sessionUser = {
    username: basicSession.username,
    avatarUrl: basicSession.avatarUrl,
    role: 'admin',
  };
} else if (sessionCookie && /^[a-f0-9]{64}$/i.test(sessionCookie)) {
  const emailConfigured = await isEmailAuthConfigured();
  if (emailConfigured) {
    const result = await validateSession(sessionCookie);
    if (result.valid) {
      sessionUser = {
        username: result.user.username || result.user.email,
        avatarUrl: null,
        role: result.user.role,
      };
    }
  }
}
const {
  displayName: projectDisplayName,
  shortDescription: projectShortDescription,
} = getAppMeta();

const repoRoot = getRepoPath();
const hasExportDir = fs.existsSync(path.join(repoRoot, "export"));
const releaseLabel = hasExportDir ? "Internal" : "Open";
const releasePrefix = hasExportDir ? "Build" : "Version";
const releaseBadgeClasses = [
  "mt-3 px-2 py-1 rounded-md border text-[10px] uppercase tracking-widest flex items-center justify-between",
  hasExportDir
    ? "bg-amber-500/10 text-amber-300 border-amber-500/30"
    : "bg-emerald-500/10 text-emerald-300 border-emerald-500/30",
];

const navItems: NavItem[] = [
  {
    label: "Dashboard",
    href: "/",
    icon: LayoutDashboard,
  },
  {
    label: "Configuration",
    href: "/configuration",
    icon: Settings2,
    subsections: [
      { label: "User Content", id: "content-location" },
      { label: "Image Hosting", id: "image-hosting" },
      { label: "Storage Diagnostics", id: "storage-diagnostics" },
      { label: "Image Processing", id: "image-processing" },
      { label: "Project State", id: "project-state" },
      { label: "Authentication", id: "authentication" },

      { label: "Git Integration", id: "git" },
      { label: "Custom Domain", id: "custom-domain" },
      { label: "Secrets", id: "secrets-vault" },
    ],
  },
  {
    label: "Settings",
    href: "/settings",
    icon: Settings,
    subsections: [
      { label: "Nav & Pages", id: "pages", href: "/settings/pages" },
      { label: "Site Settings", id: "site-settings" },
      { label: "SEO", id: "seo" },
      { label: "Identity Kit", id: "identity-kit" },
      { label: "Theme & Style", id: "theme" },
    ],
  },
  {
    label: "Art Pieces",
    href: "/gallery",
    icon: Image,
  },
  { label: "Content & Pages", href: "/content", icon: FileText },
  {
    label: "Tools",
    href: "/tools",
    icon: Wrench,
    subsections: [
      { label: "Backups", id: "backups" },
      {
        label: "Setup Wizard",
        id: "setup",
        href: "/tools/setup",
        disabled: true,
        disabledReason: "Under construction",
      },
    ],
  },
  { label: "Deployment", href: "/deployment", icon: Rocket },
];

const isActive = (href: string) => {
  if (href === "/") return currentPath === "/";
  return currentPath.startsWith(href);
};

const getActiveHash = () => {
  // This will be populated client-side based on scroll position
  return "";
};
---

<!-- Mobile header bar -->
<div
  class="lg:hidden fixed top-0 left-0 right-0 z-50 bg-admin-sidebar border-b border-admin-border h-14 flex items-center px-4"
>
  <button
    id="sidebar-toggle"
    class="p-2 text-admin-muted hover:text-admin-text"
    aria-label="Toggle menu"
  >
    <svg
      id="menu-icon"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    >
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
    <svg
      id="close-icon"
      class="hidden"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    >
      <line x1="18" y1="6" x2="6" y2="18"></line>
      <line x1="6" y1="6" x2="18" y2="18"></line>
    </svg>
  </button>
  <a
    href="/"
    class="admin-logo-link text-lg font-bold text-admin-accent ml-3 px-2 py-1 rounded transition-colors duration-200"
    >{projectDisplayName}</a
  >
</div>

<!-- Overlay for mobile -->
<div
  id="sidebar-overlay"
  class="lg:hidden fixed inset-0 bg-black/50 z-40 hidden"
>
</div>

<!-- Sidebar -->
<aside id="sidebar" class="sidebar-panel">
  <!-- Logo (hidden on mobile, shown in header instead) -->
  <a
    href="/"
    class="admin-logo hidden lg:flex items-center px-6 py-4 transition-colors duration-200 group h-[89px]"
  >
    <img
      src="/artsitemaker-logo.svg"
      alt="ArtSiteMaker Logo"
      class="logo-icon h-[4.5rem] w-auto shrink-0 object-contain transition-all duration-300 group-hover:h-10"
    />

    <!-- Text Wrapper -->
    <div
      class="logo-text-wrapper overflow-hidden whitespace-nowrap opacity-0 max-w-0 transition-all duration-300 ease-in-out group-hover:max-w-[200px] group-hover:opacity-100 group-hover:ml-3"
    >
      <p
        class="site-name text-xl font-bold text-admin-accent group-hover:text-admin-sidebar"
      >
        {projectDisplayName}
      </p>
      <p
        class="text-xs text-admin-muted mt-1 group-hover:text-admin-sidebar/80 h-4"
      >
        {projectShortDescription}
      </p>
    </div>
  </a>

  <!-- Mobile top spacing -->
  <div class="lg:hidden h-14"></div>

  <!-- Navigation -->
  <nav class="flex-1 p-4 overflow-y-auto">
    <ul class="space-y-1">
      {
        navItems.map((item) => {
          const active = isActive(item.href);
          return (
            <li>
              <a
                href={item.href}
                class:list={[
                  "flex items-center gap-3 px-4 py-3 rounded-lg transition-colors duration-200",
                  active
                    ? "bg-admin-primary/50 text-white"
                    : "text-admin-muted hover:bg-admin-card hover:text-admin-text",
                ]}
                data-nav-item={item.href}
              >
                <item.icon className="w-5 h-5" />
                <span>{item.label}</span>
                {item.subsections && item.subsections.length > 0 && (
                  <Chevron
                    class:list={[
                      "ml-auto w-4 h-4 transition-transform duration-200",
                      active ? "rotate-180" : "",
                    ]}
                  />
                )}
              </a>

              {/* Subsections - shown when active */}
              {item.subsections && item.subsections.length > 0 && (
                <ul
                  class:list={[
                    "subsection-list ml-6 mt-1 space-y-1 overflow-hidden transition-all duration-200",
                    active ? "max-h-96 opacity-100" : "max-h-0 opacity-0",
                  ]}
                  data-subsection-list={item.href}
                >
                  {item.subsections.map((sub) => (
                    <li>
                      {sub.disabled ? (
                        <span
                          class:list={[
                            "subsection-link flex items-center gap-2 px-4 py-2 text-sm rounded-lg",
                            "cursor-not-allowed opacity-60 text-admin-muted",
                          ]}
                          aria-disabled="true"
                          title={sub.disabledReason || "Unavailable"}
                        >
                          <span class="w-1.5 h-1.5 rounded-full bg-current opacity-40" />
                          <span>{sub.label}</span>
                        </span>
                      ) : (
                        <a
                          href={sub.href || `${item.href}#${sub.id}`}
                          class:list={[
                            "subsection-link flex items-center gap-2 px-4 py-2 text-sm rounded-lg transition-colors duration-150",
                            sub.href === currentPath
                              ? "active bg-admin-card text-admin-text"
                              : "text-admin-muted hover:bg-admin-card hover:text-admin-text",
                          ]}
                          data-subsection-id={sub.id}
                        >
                          <span
                            class:list={[
                              "w-1.5 h-1.5 rounded-full bg-current",
                              sub.href === currentPath
                                ? "opacity-100 text-admin-accent"
                                : "opacity-50",
                            ]}
                          />
                          <span>{sub.label}</span>
                        </a>
                      )}
                    </li>
                  ))}
                </ul>
              )}
            </li>
          );
        })
      }
    </ul>
  </nav>

  <!-- Footer -->
  <div class="p-4 border-t border-admin-border">
    {
      sessionUser && (
        <div class="flex items-center gap-3 py-2">
          <a href="/profile" class="block shrink-0 transition-opacity hover:opacity-80">
            {sessionUser.avatarUrl ? (
              <img
                src={sessionUser.avatarUrl}
                alt={sessionUser.username}
                class="w-8 h-8 rounded-full"
              />
            ) : (
              <div
                class:list={[
                  "w-8 h-8 rounded-full text-xs font-semibold flex items-center justify-center",
                  sessionUser.role === "admin"
                    ? "bg-orange-700 text-white shadow-sm shadow-orange-900/50"
                    : "bg-admin-card text-admin-text",
                ]}
                aria-hidden="true"
                title={sessionUser.role === "admin" ? "Administrator" : "User"}
              >
                {getInitials(sessionUser.username)}
              </div>
            )}
          </a>
          <div class="flex-1 min-w-0">
            <a
              href="/profile"
              class="text-sm text-admin-text truncate hover:text-admin-accent transition-colors block"
            >
              {sessionUser.username}
            </a>
          </div>
          <a
            href="/auth/logout"
            class="text-admin-muted hover:text-red-400 transition-colors"
            title="Sign out"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
              <polyline points="16 17 21 12 16 7" />
              <line x1="21" y1="12" x2="9" y2="12" />
            </svg>
          </a>
        </div>
      )
    }
    <div class:list={releaseBadgeClasses}>
      <span>{releasePrefix}</span>
      <span>{releaseLabel}</span>
    </div>
  </div>
</aside>

<style>
  .sidebar-panel {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    width: 16rem; /* w-64 */
    background: var(--admin-sidebar);
    border-right: 1px solid var(--admin-border);
    display: flex;
    flex-direction: column;
    z-index: 45;
    transition: transform 0.3s ease;
  }

  @media (max-width: 1023px) {
    .sidebar-panel {
      transform: translateX(-100%);
    }

    .sidebar-panel.open {
      transform: translateX(0);
    }
  }

  .subsection-link.active {
    background: var(--admin-card);
    color: var(--admin-text);
  }

  .subsection-link.active .w-1\.5 {
    background: var(--admin-accent);
    opacity: 1;
  }

  /* Logo link - stark contrast hover effect with trendy animations */
  .admin-logo {
    position: relative;
    overflow: hidden;
  }

  .admin-logo::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: var(--admin-accent);
    transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 0;
  }

  .admin-logo:hover::before {
    left: 0;
  }

  @media (prefers-reduced-motion: reduce) {
    .admin-logo::before {
      transition: none;
    }

    .admin-logo:hover::before {
      left: -100%;
    }
  }

  /* Ensure content sits above the background sweep */
  .logo-icon,
  .logo-text-wrapper {
    position: relative;
    z-index: 1;
  }
</style>

<script>
  const toggle = document.getElementById("sidebar-toggle");
  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("sidebar-overlay");
  const menuIcon = document.getElementById("menu-icon");
  const closeIcon = document.getElementById("close-icon");

  function openSidebar() {
    sidebar?.classList.add("open");
    overlay?.classList.remove("hidden");
    menuIcon?.classList.add("hidden");
    closeIcon?.classList.remove("hidden");
  }

  function closeSidebar() {
    sidebar?.classList.remove("open");
    overlay?.classList.add("hidden");
    menuIcon?.classList.remove("hidden");
    closeIcon?.classList.add("hidden");
  }

  toggle?.addEventListener("click", () => {
    if (sidebar?.classList.contains("open")) {
      closeSidebar();
    } else {
      openSidebar();
    }
  });

  overlay?.addEventListener("click", closeSidebar);

  // Close on navigation
  sidebar?.querySelectorAll("a").forEach((link) => {
    link.addEventListener("click", () => {
      if (window.innerWidth < 1024) {
        closeSidebar();
      }
    });
  });

  // Smooth scroll for subsection links
  document.querySelectorAll(".subsection-link").forEach((link) => {
    link.addEventListener("click", (e) => {
      const href = (e.currentTarget as HTMLAnchorElement).getAttribute("href");
      if (href && href.includes("#")) {
        const hash = href.split("#")[1];
        const target = document.getElementById(hash);
        if (target) {
          e.preventDefault();
          target.scrollIntoView({ behavior: "smooth", block: "start" });
          // Update URL without triggering navigation
          history.pushState(null, "", href);
        }
      }
    });
  });

  // Scrollspy - highlight current subsection based on scroll position
  function updateActiveSubsection() {
    const subsectionLinks = document.querySelectorAll(".subsection-link");
    const scrollPosition = window.scrollY + 100; // Offset for header

    let activeId = "";

    subsectionLinks.forEach((link) => {
      const id = link.getAttribute("data-subsection-id");
      if (id) {
        const section = document.getElementById(id);
        if (section) {
          const rect = section.getBoundingClientRect();
          const sectionTop = rect.top + window.scrollY;

          if (scrollPosition >= sectionTop) {
            activeId = id;
          }
        }
      }
    });

    // Update active states
    subsectionLinks.forEach((link) => {
      const id = link.getAttribute("data-subsection-id");
      const href = link.getAttribute("href");
      const isPathMatch = href === window.location.pathname;

      if (id === activeId || isPathMatch) {
        link.classList.add("active");
        // Add specific styling classes if needed (since they were removed if not active)
        if (isPathMatch) {
          link.classList.remove("text-admin-muted");
          link.classList.add("bg-admin-card", "text-admin-text");
        }
      } else {
        link.classList.remove("active");
        // Revert styling only if it was NOT a path match check (but here we are in else so it is not)
        // However, we need to be careful not to strip classes if we are just switching sections on same page
        if (!link.classList.contains("active")) {
          link.classList.remove("bg-admin-card", "text-admin-text");
          link.classList.add("text-admin-muted");
        }
      }
    });
  }

  // Throttled scroll handler
  let scrollTimeout: number | null = null;
  window.addEventListener("scroll", () => {
    if (scrollTimeout) return;
    scrollTimeout = window.setTimeout(() => {
      updateActiveSubsection();
      scrollTimeout = null;
    }, 100);
  });

  // Initial check
  updateActiveSubsection();

  // Handle initial hash in URL
  if (window.location.hash) {
    const target = document.getElementById(window.location.hash.slice(1));
    if (target) {
      setTimeout(() => {
        target.scrollIntoView({ behavior: "smooth", block: "start" });
      }, 100);
    }
  }
</script>

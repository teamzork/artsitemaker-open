---
import Button from '../ui/Button.astro';
import { Toggle } from '../ui/Toggle';
import Modal from '../Modal.astro';

interface Props {
  showHeader?: boolean;
  compact?: boolean;
  containerId?: string;
}

const {
  showHeader = true,
  compact = false,
  containerId = 'secrets-vault',
} = Astro.props;
---

<div data-secrets-vault-root>
  <div
    id={containerId}
    class:list={[
      'max-w-4xl space-y-8 scroll-mt-24',
      { 'space-y-4 mt-0 pb-0': compact, 'mt-8 pb-24': !compact },
    ]}
  >
    <!-- Status Card -->
    <div id="secrets-status-card" class="card">
      {showHeader && (
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">ğŸ” Secrets Vault</h2>
          <div class="flex items-center gap-3">
            <details id="why-unlock" class="relative">
              <summary
                class="text-sm text-admin-muted underline underline-offset-2 cursor-pointer hover:text-admin-text list-none"
              >
                Why Unlock
              </summary>
              <div
                id="why-unlock-panel"
                class="why-unlock-panel absolute left-0 mt-2 w-80 rounded-lg border border-admin-border bg-admin-sidebar/95 p-4 text-sm text-admin-muted shadow-lg z-10"
              >
                <p class="font-semibold text-admin-text mb-3">
                  Unlock when you need to:
                </p>
                <ul class="space-y-2 list-disc list-outside pl-4 leading-relaxed">
                  <li>View or edit stored credentials (R2, Cloudflare, GitHub)</li>
                  <li>Use R2 cloud storage for images</li>
                  <li>Deploy to Cloudflare Pages</li>
                  <li>Use GitHub OAuth for admin login</li>
                </ul>
              </div>
            </details>
            <div id="vault-status" class="flex items-center gap-2">
              <span class="status-indicator"></span>
              <span class="status-text text-sm">Checking...</span>
            </div>
          </div>
        </div>
      )}

    <!-- Not Initialized State -->
    <div id="state-not-initialized" class="hidden">
      <p class="text-admin-muted mb-4">
        Set up a master password to securely store sensitive credentials like
        API keys, OAuth secrets, and deployment credentials.
      </p>
      <div class="bg-admin-sidebar/50 rounded-lg p-4 mb-4">
        <h3 class="font-medium mb-2">âš ï¸ Important</h3>
        <ul class="text-sm text-admin-muted space-y-1 list-disc list-inside">
          <li>Your master password cannot be recovered if lost</li>
          <li>All secrets will be encrypted with AES-256-GCM</li>
          <li>Sessions auto-lock after 1 hour of inactivity</li>
        </ul>
      </div>
      <Button id="setup-btn" variant="primary">Set Up Master Password</Button>
    </div>

    <!-- Locked State -->
    <div id="state-locked" class="hidden">
      <p class="text-admin-muted mb-4">
        The secrets vault is locked. Enter your master password to access and
        manage credentials.
      </p>

      <form id="unlock-form" class="space-y-4">
        <div>
          <label class="block text-sm text-admin-muted mb-2"
            >Master Password</label
          >
          <input
            type="password"
            id="unlock-password"
            class="w-full"
            placeholder="Enter master password"
            autocomplete="off"
          />
        </div>
        <div
          id="unlock-error"
          class="text-red-400 text-sm hidden flex items-center gap-1"
        >
          <span id="unlock-error-text"></span>
          <Button
            type="button"
            id="unlock-reset-link"
            variant="ghost"
            size="sm"
            class="inline-flex align-baseline px-0 py-0 text-red-300 underline underline-offset-2 hover:text-red-200 hover:bg-transparent hidden"
          >
            Reset the vault
          </Button>
        </div>
        <Button type="submit" variant="primary">Unlock Vault</Button>
      </form>
    </div>

    <!-- Unlocked State -->
    <div id="state-unlocked" class="hidden">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <span class="text-green-400">âœ“ Vault Unlocked</span>
          <span id="session-timer" class="text-xs text-admin-muted"></span>
        </div>
        <Button id="lock-btn" variant="secondary" size="sm"
          >ğŸ”’ Lock Now</Button
        >
      </div>
    </div>

    <!-- Session Persistence (only visible when initialized) -->
    <div
      id="persistence-card"
      class="persistence-panel persistence-collapsed hidden"
    >
      <div class="border-t border-admin-border pt-4 mt-6">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-sm font-semibold">Session Persistence</h3>
            <p class="text-sm text-admin-muted mt-1">
              Persist unlocked session across server restarts (1-hour TTL).
              <span class="text-yellow-400/80"
                >Less secure but more convenient.</span
              >
            </p>
          </div>
          <Toggle
            client:load
            name="persistSession"
            label="Session persistence"
            labelHidden
            containerId="persist-session-toggle"
          />
        </div>
        <div
          id="persistence-status"
          class="text-xs text-admin-muted mt-2"
        ></div>
      </div>
    </div>
  </div>

  <!-- Secrets Editor (only visible when unlocked) -->
  <div id="secrets-editor" class="space-y-6 hidden">
    <!-- R2 Storage Credentials -->
    <div class="card">
      <h3 class="text-lg font-semibold mb-4">â˜ï¸ R2 Storage Credentials</h3>
      <p class="text-sm text-admin-muted mb-4">
        Cloudflare R2 credentials for storing processed images in the cloud.
      </p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-admin-muted mb-2">Account ID</label>
          <input
            type="text"
            id="r2-account-id"
            class="w-full font-mono text-sm"
            placeholder="abc123..."
          />
        </div>
        <div>
          <label class="block text-sm text-admin-muted mb-2"
            >Access Key ID</label
          >
          <input
            type="text"
            id="r2-access-key-id"
            class="w-full font-mono text-sm"
            placeholder="xyz789..."
          />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-admin-muted mb-2"
            >Secret Access Key</label
          >
          <div class="flex gap-2">
            <input
              type="password"
              id="r2-secret-access-key"
              class="flex-1 font-mono text-sm"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            />
            <Button
              type="button"
              variant="ghost"
              size="sm"
              class="toggle-visibility"
              data-target="r2-secret-access-key">ğŸ‘</Button
            >
          </div>
        </div>
      </div>
      <p class="text-xs text-admin-muted mt-4">
        Bucket Name, Public URL, and Project Folder are configured in the <a
          href="#image-hosting"
          class="text-blue-400 hover:underline">Image Hosting</a
        > section above.
      </p>
    </div>

    <!-- Cloudflare Pages Credentials -->
    <div class="card">
      <div class="flex items-center justify-between gap-3 mb-2">
        <h3 class="text-lg font-semibold">
          ğŸŒ©ï¸ Cloudflare Pages Credentials
        </h3>
        <Button type="button" variant="secondary" size="sm" id="test-cf-btn">
          ğŸ”— Test Connection
        </Button>
      </div>
      <p class="text-sm text-admin-muted mb-4">
        Credentials for deploying to Cloudflare Pages.
      </p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-admin-muted mb-2">Account ID</label>
          <input
            type="text"
            id="cf-account-id"
            class="w-full font-mono text-sm"
            placeholder="abc123..."
          />
        </div>
        <div>
          <label class="block text-sm text-admin-muted mb-2">API Token</label>
          <div class="flex gap-2">
            <input
              type="password"
              id="cf-api-token"
              class="flex-1 font-mono text-sm"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            />
            <Button
              type="button"
              variant="ghost"
              size="sm"
              class="toggle-visibility"
              data-target="cf-api-token">ğŸ‘</Button
            >
          </div>
        </div>
      </div>
      <p class="text-xs text-admin-muted mt-4">
        Test these credentials against the Cloudflare API.
      </p>
      <div id="cf-test-status" class="text-sm mt-3"></div>
    </div>

    <!-- GitHub OAuth Credentials -->
    <div class="card">
      <h3 class="text-lg font-semibold mb-4">ğŸ”‘ GitHub OAuth Credentials</h3>
      <p class="text-sm text-admin-muted mb-4">
        GitHub OAuth app credentials for admin authentication.
      </p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-admin-muted mb-2">Client ID</label>
          <input
            type="text"
            id="github-client-id"
            class="w-full font-mono text-sm"
            placeholder="Ov23li..."
          />
        </div>
        <div>
          <label class="block text-sm text-admin-muted mb-2"
            >Client Secret</label
          >
          <div class="flex gap-2">
            <input
              type="password"
              id="github-client-secret"
              class="flex-1 font-mono text-sm"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            />
            <Button
              type="button"
              variant="ghost"
              size="sm"
              class="toggle-visibility"
              data-target="github-client-secret">ğŸ‘</Button
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Deployment Credentials -->
    <div class="card">
      <h3 class="text-lg font-semibold mb-4">ğŸš€ Deployment Credentials</h3>
      <p class="text-sm text-admin-muted mb-4">
        Credentials for automated deployment (FTP/SFTP or Git).
      </p>

      <div class="mb-4">
        <label class="block text-sm text-admin-muted mb-2"
          >Deployment Type</label
        >
        <select id="deploy-type" class="w-full bg-admin-sidebar">
          <option value="">Not configured</option>
          <option value="ftp">FTP/SFTP</option>
          <option value="git">Git (GitHub Pages)</option>
        </select>
      </div>

      <!-- FTP Fields -->
      <div
        id="ftp-fields"
        class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden"
      >
        <div>
          <label class="block text-sm text-admin-muted mb-2">Host</label>
          <input
            type="text"
            id="ftp-host"
            class="w-full"
            placeholder="ftp.example.com"
          />
        </div>
        <div>
          <label class="block text-sm text-admin-muted mb-2">Username</label>
          <input
            type="text"
            id="ftp-user"
            class="w-full"
            placeholder="deploy-user"
          />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-admin-muted mb-2">Password</label>
          <div class="flex gap-2">
            <input
              type="password"
              id="ftp-password"
              class="flex-1"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            />
            <Button
              type="button"
              variant="ghost"
              size="sm"
              class="toggle-visibility"
              data-target="ftp-password">ğŸ‘</Button
            >
          </div>
        </div>
      </div>

      <!-- Git Fields -->
      <div
        id="git-fields"
        class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden"
      >
        <div class="md:col-span-2">
          <label class="block text-sm text-admin-muted mb-2"
            >GitHub Token (PAT)</label
          >
          <div class="flex gap-2">
            <input
              type="password"
              id="github-token"
              class="flex-1 font-mono text-sm"
              placeholder="ghp_..."
            />
            <Button
              type="button"
              variant="ghost"
              size="sm"
              class="toggle-visibility"
              data-target="github-token">ğŸ‘</Button
            >
          </div>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-admin-muted mb-2"
            >Deploy Repository</label
          >
          <input
            type="text"
            id="deploy-repo"
            class="w-full"
            placeholder="username/repo"
          />
        </div>
      </div>
    </div>

    <!-- Save Button -->
    <div class="flex justify-end pt-4 border-t border-admin-border">
      <Button id="save-secrets-btn" type="button" variant="primary"
        >ğŸ’¾ Save Secrets</Button
      >
    </div>
  </div>
  </div>

<!-- Setup Master Password Modal -->
<Modal
  id="setup-modal"
  title="Set Up Master Password"
  confirmText="Create Password"
  closeText="Cancel"
>
  <div class="space-y-4">
    <div
      class="bg-yellow-900/30 border border-yellow-600/50 rounded-lg p-4 mb-4"
    >
      <h4 class="font-medium text-yellow-400 mb-2">âš ï¸ No Recovery Option</h4>
      <p class="text-sm text-yellow-200/80">
        If you forget your master password, there is <strong
          >no way to recover</strong
        > your encrypted secrets. You would need to delete the secrets file and
        start over.
      </p>
    </div>

    <div>
      <label class="block text-sm text-admin-muted mb-2"
        >Master Password</label
      >
      <input
        type="password"
        id="setup-password"
        class="w-full"
        placeholder="Create a strong password"
        autocomplete="new-password"
      />
      <div id="password-strength" class="mt-2 space-y-1"></div>
    </div>

    <div>
      <label class="block text-sm text-admin-muted mb-2"
        >Confirm Password</label
      >
      <input
        type="password"
        id="setup-confirm"
        class="w-full"
        placeholder="Re-enter password"
        autocomplete="new-password"
      />
    </div>

    <div id="setup-error" class="text-red-400 text-sm hidden"></div>
  </div>
</Modal>

<!-- Reset Vault Modal -->
<Modal
  id="reset-vault-modal"
  title="Reset Secrets Vault"
  confirmText="Reset Vault"
  closeText="Cancel"
  variant="danger"
>
  <p class="text-sm text-admin-muted mb-4">
    If you no longer have the master password, the only option is to reset the
    vault. This permanently deletes all stored secrets (R2, GitHub, Cloudflare,
    and deployment credentials).
  </p>
  <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-3 text-sm text-red-200">
    This action cannot be undone. You will need to set a new master password
    and re-enter your credentials.
  </div>
  <div id="reset-error" class="text-red-400 text-sm mt-3 hidden"></div>
</Modal>

<script>
  import '../../scripts/vault-init.ts';
</script>

  <style is:global>
    @import './secrets-vault.css';
  </style>
</div>

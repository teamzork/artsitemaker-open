---
import Button from "../ui/Button.astro";
import { Toggle } from "../ui/Toggle";
import Modal from "../Modal.astro";
import { Lock, Eye, AlertTriangle, CheckCircle, Cloud, Link, Rocket } from "lucide-react";

interface Props {
  showHeader?: boolean;
  compact?: boolean;
  containerId?: string;
}

const {
  showHeader = true,
  compact = false,
  containerId = "secrets-vault",
} = Astro.props;
---

<div data-secrets-vault-root>
  <div
    id={containerId}
    class:list={[
      "max-w-4xl space-y-8 scroll-mt-24",
      { "space-y-4 mt-0 pb-0": compact, "mt-8 pb-24": !compact },
    ]}
  >
    <!-- Status Card -->
    <div id="secrets-status-card" class="card">
      {
        showHeader && (
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2 mb-4">
              <Lock className="w-5 h-5 text-admin-accent" />
              <h2 class="text-lg font-semibold">Secrets Vault</h2>
            </div>
            <div class="flex items-center gap-3">
              <details id="why-unlock" class="relative">
                <summary class="text-sm text-admin-muted underline underline-offset-2 cursor-pointer hover:text-admin-text list-none">
                  Why Unlock
                </summary>
                <div
                  id="why-unlock-panel"
                  class="why-unlock-panel absolute left-0 mt-2 w-80 rounded-lg border border-admin-border bg-admin-sidebar/95 p-4 text-sm text-admin-muted shadow-lg z-10"
                >
                  <p class="font-semibold text-admin-text mb-3">
                    Unlock when you need to:
                  </p>
                  <ul class="space-y-2 list-disc list-outside pl-4 leading-relaxed">
                    <li>
                      View or edit stored credentials (R2, Cloudflare, GitHub)
                    </li>
                    <li>Use R2 cloud storage for images</li>
                    <li>Deploy to Cloudflare Pages</li>
                    <li>Use GitHub OAuth for admin login</li>
                  </ul>
                </div>
              </details>
              <div id="vault-status" class="flex items-center gap-2">
                <span class="status-indicator" />
                <span class="status-text text-sm">Checking...</span>
              </div>
            </div>
          </div>
        )
      }

      <!-- Not Initialized State -->
      <div id="state-not-initialized" class="hidden">
        <p class="text-admin-muted mb-4">
          Set up a master password to securely store sensitive credentials like
          API keys, OAuth secrets, and deployment credentials.
        </p>
        <div class="bg-admin-sidebar/50 rounded-lg p-4 mb-4">
          <h3 class="font-medium mb-2 flex items-center gap-2"><AlertTriangle className="w-4 h-4 text-yellow-300" /> Important</h3>
          <ul class="text-sm text-admin-muted space-y-1 list-disc list-inside">
            <li>Your master password cannot be recovered if lost</li>
            <li>All secrets will be encrypted with AES-256-GCM</li>
            <li>Sessions auto-lock after 1 hour of inactivity</li>
          </ul>
        </div>
        <Button id="setup-btn" variant="primary">Set Up Master Password</Button>
      </div>

      <!-- Locked State -->
      <div id="state-locked" class="hidden">
        <p class="text-admin-muted mb-4">
          The secrets vault is locked. Enter your master password to access and
          manage credentials.
        </p>

        <form id="unlock-form" class="space-y-4">
          <div>
            <label class="block text-sm text-admin-muted mb-2"
              >Master Password</label
            >
            <input
              type="password"
              id="unlock-password"
              class="w-full"
              placeholder="Enter master password"
              autocomplete="off"
            />
          </div>
          <div
            id="unlock-error"
            class="text-red-400 text-sm hidden flex items-center gap-1"
          >
            <span id="unlock-error-text"></span>
            <Button
              type="button"
              id="unlock-reset-link"
              variant="ghost"
              size="sm"
              class="inline-flex align-baseline px-0 py-0 text-red-300 underline underline-offset-2 hover:text-red-200 hover:bg-transparent hidden"
            >
              Reset the vault
            </Button>
          </div>
          <Button type="submit" variant="primary">Unlock Vault</Button>
        </form>
      </div>

      <!-- Unlocked State -->
      <div id="state-unlocked" class="hidden">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span class="text-green-300 flex items-center gap-1"><CheckCircle className="w-4 h-4" /> Vault Unlocked</span>
            <span id="session-timer" class="text-xs text-admin-muted"></span>
          </div>
          <Button id="lock-btn" variant="secondary" size="sm"
            ><Lock className="w-4 h-4" /> Lock Now</Button
          >
        </div>
      </div>

      <!-- Session Persistence (only visible when initialized) -->
      <div
        id="persistence-card"
        class="persistence-panel persistence-collapsed hidden"
      >
        <div class="border-t border-admin-border pt-4 mt-6">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-sm font-semibold">Session Persistence</h3>
              <p class="text-sm text-admin-muted mt-1">
                Persist unlocked session across server restarts (1-hour TTL).
                <span class="text-yellow-400/80"
                  >Less secure but more convenient.</span
                >
              </p>
            </div>
            <Toggle
              client:load
              name="persistSession"
              label="Session persistence"
              labelHidden
              containerId="persist-session-toggle"
            />
          </div>
          <div id="persistence-status" class="text-xs text-admin-muted mt-2">
          </div>
        </div>
      </div>
    </div>

    <!-- Secrets Editor (only visible when unlocked) -->
    <div id="secrets-editor" class="space-y-6 hidden">
      <!-- R2 Storage Credentials -->
      <div class="card">
        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2"><Cloud className="w-5 h-5 text-blue-300" /> R2 Storage Credentials</h3>
        <p class="text-sm text-admin-muted mb-4">
          Cloudflare R2 credentials for storing processed images in the cloud.
        </p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-admin-muted mb-2">Account ID</label
            >
            <input
              type="text"
              id="r2-account-id"
              class="w-full font-mono text-sm"
              placeholder="abc123..."
            />
          </div>
          <div>
            <label class="block text-sm text-admin-muted mb-2"
              >Access Key ID</label
            >
            <input
              type="text"
              id="r2-access-key-id"
              class="w-full font-mono text-sm"
              placeholder="xyz789..."
            />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm text-admin-muted mb-2"
              >Secret Access Key</label
            >
            <div class="flex gap-2">
              <input
                type="password"
                id="r2-secret-access-key"
                class="flex-1 font-mono text-sm"
                placeholder="••••••••"
              />
              <Button
                type="button"
                variant="ghost"
                size="sm"
                class="toggle-visibility"
                data-target="r2-secret-access-key"
                ><Eye className="w-4 h-4" /></Button
              >
            </div>
          </div>
        </div>
        <p class="text-xs text-admin-muted mt-4">
          Bucket Name, Public URL, and Project Folder are configured in the <a
            href="#image-hosting"
            class="text-blue-400 hover:underline">Image Hosting</a
          > section above.
        </p>
      </div>

      <!-- Cloudflare Pages Credentials -->
      <div class="card">
        <div class="flex items-center justify-between gap-3 mb-2">
          <h3 class="text-lg font-semibold flex items-center gap-2"><Cloud className="w-5 h-5 text-yellow-300" /> Cloudflare Pages Credentials</h3>
          <Button type="button" variant="secondary" size="sm" id="test-cf-btn">
            <Link className="w-4 h-4" /> Test Connection
          </Button>
        </div>
        <p class="text-sm text-admin-muted mb-4">
          Credentials for deploying to Cloudflare Pages.
        </p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-admin-muted mb-2">Account ID</label
            >
            <input
              type="text"
              id="cf-account-id"
              class="w-full font-mono text-sm"
              placeholder="abc123..."
            />
          </div>
          <div>
            <label class="block text-sm text-admin-muted mb-2">API Token</label>
            <div class="flex gap-2">
              <input
                type="password"
                id="cf-api-token"
                class="flex-1 font-mono text-sm"
                placeholder="••••••••"
              />
              <Button
                type="button"
                variant="ghost"
                size="sm"
                class="toggle-visibility"
                data-target="cf-api-token"
                ><Eye className="w-4 h-4" /></Button
              >
            </div>
          </div>
        </div>
        <p class="text-xs text-admin-muted mt-4">
          Test these credentials against the Cloudflare API.
        </p>
        <div id="cf-test-status" class="text-sm mt-3"></div>
      </div>

      <!-- GitHub OAuth Credentials -->
      <div class="card">
        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="text-gray-300"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg> GitHub OAuth Credentials</h3>
        <p class="text-sm text-admin-muted mb-4">
          GitHub OAuth app credentials for admin authentication.
        </p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-admin-muted mb-2">Client ID</label>
            <input
              type="text"
              id="github-client-id"
              class="w-full font-mono text-sm"
              placeholder="Ov23li..."
            />
          </div>
          <div>
            <label class="block text-sm text-admin-muted mb-2"
              >Client Secret</label
            >
            <div class="flex gap-2">
              <input
                type="password"
                id="github-client-secret"
                class="flex-1 font-mono text-sm"
                placeholder="••••••••"
              />
              <Button
                type="button"
                variant="ghost"
                size="sm"
                class="toggle-visibility"
                data-target="github-client-secret"><Eye className="w-4 h-4" /></Button
              >
            </div>
          </div>
        </div>
      </div>

      <!-- Deployment Credentials -->
      <div class="card">
        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2"><Rocket className="w-5 h-5 text-orange-300" /> Deployment Credentials</h3>
        <p class="text-sm text-admin-muted mb-4">
          Credentials for automated deployment (FTP/SFTP or Git).
        </p>

        <div class="mb-4">
          <label class="block text-sm text-admin-muted mb-2"
            >Deployment Type</label
          >
          <select id="deploy-type" class="w-full bg-admin-sidebar">
            <option value="">Not configured</option>
            <option value="ftp">FTP/SFTP</option>
            <option value="git">Git (GitHub Pages)</option>
          </select>
        </div>

        <!-- FTP Fields -->
        <div
          id="ftp-fields"
          class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden"
        >
          <div>
            <label class="block text-sm text-admin-muted mb-2">Host</label>
            <input
              type="text"
              id="ftp-host"
              class="w-full"
              placeholder="ftp.example.com"
            />
          </div>
          <div>
            <label class="block text-sm text-admin-muted mb-2">Username</label>
            <input
              type="text"
              id="ftp-user"
              class="w-full"
              placeholder="deploy-user"
            />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm text-admin-muted mb-2">Password</label>
            <div class="flex gap-2">
              <input
                type="password"
                id="ftp-password"
                class="flex-1"
                placeholder="••••••••"
              />
              <Button
                type="button"
                variant="ghost"
                size="sm"
                class="toggle-visibility"
                data-target="ftp-password"><Eye className="w-4 h-4" /></Button
              >
            </div>
          </div>
        </div>

        <!-- Git Fields -->
        <div
          id="git-fields"
          class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden"
        >
          <div class="md:col-span-2">
            <label class="block text-sm text-admin-muted mb-2"
              >GitHub Token (PAT)</label
            >
            <div class="flex gap-2">
              <input
                type="password"
                id="github-token"
                class="flex-1 font-mono text-sm"
                placeholder="ghp_..."
              />
              <Button
                type="button"
                variant="ghost"
                size="sm"
                class="toggle-visibility"
                data-target="github-token"><Eye className="w-4 h-4" /></Button
              >
            </div>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm text-admin-muted mb-2"
              >Deploy Repository</label
            >
            <input
              type="text"
              id="deploy-repo"
              class="w-full"
              placeholder="username/repo"
            />
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Reset Vault Modal -->
  <Modal
    id="reset-vault-modal"
    title="Reset Secrets Vault"
    confirmText="Reset Vault"
    closeText="Cancel"
    variant="danger"
  >
    <p class="text-sm text-admin-muted mb-4">
      If you no longer have the master password, the only option is to reset the
      vault. This permanently deletes all stored secrets (R2, GitHub,
      Cloudflare, and deployment credentials).
    </p>
    <div
      class="bg-red-500/10 border border-red-500/30 rounded-lg p-3 text-sm text-red-200"
    >
      This action cannot be undone. You will need to set a new master password
      and re-enter your credentials.
    </div>
    <div id="reset-error" class="text-red-400 text-sm mt-3 hidden"></div>
  </Modal>

  <script>
    import "../../scripts/vault-init.ts";
  </script>

  <style is:global>
    @import "./secrets-vault.css";
  </style>
</div>

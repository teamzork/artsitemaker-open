---
// packages/admin/src/pages/login.astro
// Multi-method login page: none, basic (password), email (Neon DB), GitHub OAuth

import BaseLayout from "@layouts/BaseLayout.astro";
import {
  isAuthenticatedAsync,
  getAuthMethod,
  getAuthConfig,
  isBasicAuthConfigured,
  isOAuthConfigured,
} from "@lib/auth";
import { isEmailAuthConfigured } from "@lib/db-auth";
import { getAppDisplayName } from "../lib/app-config";
import { ArrowRight, LogIn, Eye } from "lucide-react";

// If already authenticated, redirect to dashboard
const authCheck = await isAuthenticatedAsync(Astro.cookies);
if (authCheck.authenticated) {
  return Astro.redirect("/");
}

const authMethod = getAuthMethod();

// If auth method is 'none', nobody should land here — redirect to dashboard
if (authMethod === "none") {
  return Astro.redirect("/");
}

const error = Astro.url.searchParams.get("error");
const customMessage = Astro.url.searchParams.get("message");

const errorMessages: Record<string, string> = {
  not_configured:
    "Authentication is not configured. Please set up credentials in Configuration → Authentication.",
  access_denied:
    "Access denied. You are not authorized to access this admin panel.",
  auth_failed: "Authentication failed. Please try again.",
  no_code: "No authorization code received from GitHub.",
  invalid_credentials: "Invalid email or password.",
  missing_credentials: "Please enter both email and password.",
  auth_required: customMessage || "Authentication method mismatch.",
};

const errorMessage = error
  ? errorMessages[error] || customMessage || "An error occurred. Please try again."
  : null;

const authConfig = getAuthConfig();
const isGithubConfigured = await isOAuthConfigured();
const isBasicConfigured = isBasicAuthConfigured();
const isEmailConfigured = await isEmailAuthConfigured();
const savedEmail = Astro.url.searchParams.get("email") || "";
const appDisplayName = getAppDisplayName();
---

<BaseLayout title="Login">
  <div class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-sm">
      <!-- Logo/Title -->
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-white mb-2">{appDisplayName}</h1>
        <p class="text-admin-muted">Sign in to manage your gallery</p>
      </div>

      <!-- Login Card -->
      <div class="card">
        {
          errorMessage && (
            <div class="mb-6 p-4 bg-red-500/10 border border-red-500/20 rounded-lg">
              <p class="text-red-400 text-sm">{errorMessage}</p>
            </div>
          )
        }

        {/* Info banner: Email DB configured */}
        {
          authMethod !== "email" && isEmailConfigured && (
            <div class="mb-6 p-4 bg-blue-500/10 border border-blue-500/20 rounded-lg">
              <p class="text-blue-400 text-sm mb-2">
                <strong>Email authentication is available!</strong>
              </p>
              <p class="text-admin-muted text-xs mb-3">
                Your database is configured. Create an account to sign in with email.
              </p>
              <a
                href="/signup"
                class="text-xs text-blue-400 hover:underline"
              >
                Create account →
              </a>
            </div>
          )
        }

        {/* ── Basic Auth Login Form ── */}
        {
          authMethod === "basic" &&
            (isBasicConfigured ? (
              <form method="POST" action="/auth/basic-login" class="space-y-4">
                <div>
                  <label
                    for="username"
                    class="block text-sm text-admin-muted mb-2"
                  >
                    Username
                  </label>
                  <input
                    type="text"
                    id="username"
                    name="username"
                    value={authConfig.basic?.username || "admin"}
                    class="w-full px-3 py-2 bg-admin-bg border border-admin-border rounded-lg text-white focus:outline-none focus:border-admin-accent"
                    autocomplete="username"
                    required
                  />
                </div>
                <div>
                  <label
                    for="password"
                    class="block text-sm text-admin-muted mb-2"
                  >
                    Password
                  </label>
                  <div class="relative">
                    <input
                      type="password"
                      id="password"
                      name="password"
                      class="w-full px-3 py-2 bg-admin-bg border border-admin-border rounded-lg text-white focus:outline-none focus:border-admin-accent pr-10"
                      autocomplete="current-password"
                      placeholder="Enter your password"
                      required
                    />
                    <button
                      type="button"
                      class="absolute right-3 top-1/2 -translate-y-1/2 text-admin-muted hover:text-admin-main"
                      onclick="const i=document.getElementById('password');i.type=i.type==='password'?'text':'password'"
                    >
                      <Eye className="w-4 h-4" />
                    </button>
                  </div>
                  {error === "invalid_credentials" &&
                    authConfig.basic?.passwordHint && (
                      <p class="mt-2 text-xs text-admin-muted">
                        <span class="text-admin-accent">Hint:</span>{" "}
                        {authConfig.basic.passwordHint}
                      </p>
                    )}
                </div>
                <div class="mt-6">
                  <button
                    type="submit"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-admin-accent hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-admin-accent transition-colors"
                  >
                    Sign in
                  </button>
                </div>
              </form>
            ) : (
              <div class="text-center">
                <div class="mb-4 p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
                  <p class="text-yellow-400 text-sm">
                    Password not set up yet.
                  </p>
                </div>
                <p class="text-admin-muted text-sm">
                  Go to{" "}
                  <strong>Configuration → Authentication → Basic Auth</strong>{" "}
                  and set a password to enable login.
                </p>
              </div>
            ))
        }

        {/* ── Email Auth Login Form ── */}
        {
          authMethod === "email" &&
            (isEmailConfigured ? (
              <form method="POST" action="/auth/email-login" class="space-y-4">
                <div>
                  <label
                    for="email"
                    class="block text-sm text-admin-muted mb-2"
                  >
                    Email
                  </label>
                  <input
                    type="email"
                    id="email"
                    name="email"
                    value={savedEmail}
                    class="w-full px-3 py-2 bg-admin-bg border border-admin-border rounded-lg text-white focus:outline-none focus:border-admin-accent"
                    autocomplete="email"
                    placeholder="you@example.com"
                    required
                  />
                </div>
                <div>
                  <label
                    for="password"
                    class="block text-sm text-admin-muted mb-2"
                  >
                    Password
                  </label>
                  <div class="relative">
                    <input
                      type="password"
                      id="password"
                      name="password"
                      class="w-full px-3 py-2 bg-admin-bg border border-admin-border rounded-lg text-white focus:outline-none focus:border-admin-accent pr-10"
                      autocomplete="current-password"
                      placeholder="Enter your password"
                      required
                    />
                    <button
                      type="button"
                      class="absolute right-3 top-1/2 -translate-y-1/2 text-admin-muted hover:text-admin-main"
                      onclick="const i=document.getElementById('password');i.type=i.type==='password'?'text':'password'"
                    >
                      <Eye className="w-4 h-4" />
                    </button>
                  </div>
                </div>
                <div class="mt-6">
                  <button
                    type="submit"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-admin-accent hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-admin-accent transition-colors"
                  >
                    Sign in
                  </button>
                </div>
              </form>
            ) : (
              <div class="text-center">
                <div class="mb-4 p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
                  <p class="text-yellow-400 text-sm">
                    Email authentication is not configured.
                  </p>
                </div>
                <p class="text-admin-muted text-sm">
                  Set the <code class="bg-admin-bg px-1 rounded">DATABASE_URL</code> environment variable to enable email login.
                </p>
              </div>
            ))
        }

        {/* ── Email signup link ── */}
        {
          authMethod === "email" && isEmailConfigured && (
            <div class="mt-6 pt-6 border-t border-admin-border text-center">
              <a
                href="/signup"
                class="text-sm text-admin-muted hover:text-admin-accent"
              >
                Don't have an account? Sign up
              </a>
            </div>
          )
        }

        {/* ── GitHub OAuth Login ── */}
        {
          authMethod === "github" &&
            (isGithubConfigured ? (
              <a
                href="/auth/login"
                class="flex items-center justify-center gap-3 w-full py-3 px-4 bg-[#24292e] hover:bg-[#2f363d] text-white rounded-lg transition-colors"
              >
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    fill-rule="evenodd"
                    d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"
                    clip-rule="evenodd"
                  />
                </svg>
                <span class="font-medium">Sign in with GitHub</span>
              </a>
            ) : (
              <div class="text-center">
                <div class="mb-4 p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
                  <p class="text-yellow-400 text-sm">
                    GitHub OAuth is not configured.
                  </p>
                </div>
                <p class="text-admin-muted text-sm mb-4">
                  To enable authentication, set the following environment
                  variables:
                </p>
                <div class="bg-admin-sidebar p-3 rounded-lg text-left text-xs font-mono">
                  <p class="text-green-400">GITHUB_CLIENT_ID=your_client_id</p>
                  <p class="text-green-400">GITHUB_CLIENT_SECRET=your_secret</p>
                  <p class="text-green-400">
                    GITHUB_ALLOWED_USERS=your_username
                  </p>
                </div>
              </div>
            ))
        }

        {/* ── Footer link (GitHub only) ── */}
        {
          authMethod === "github" && (
            <div class="mt-6 pt-6 border-t border-admin-border text-center">
              <p class="text-xs text-admin-muted">
                Need to create a GitHub OAuth App?
                <a
                  href="https://github.com/settings/developers"
                  target="_blank"
                  rel="noopener"
                  class="text-admin-accent hover:underline ml-1"
                >
                  GitHub Developer Settings{" "}
                  <ArrowRight className="w-3 h-3 ml-1 inline-block" />
                </a>
              </p>
            </div>
          )
        }
      </div>

      <!-- Footer -->
      <p class="text-center text-xs text-admin-muted mt-8">
        ArtSiteMaker • Portfolio CMS
      </p>
    </div>
  </div>
</BaseLayout>

<style>
  .card {
    background: var(--admin-sidebar, #1a1a1a);
    border: 1px solid var(--admin-border, #333);
    border-radius: 12px;
    padding: 24px;
  }
</style>

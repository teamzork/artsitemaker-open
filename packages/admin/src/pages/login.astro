---
// packages/admin/src/pages/login.astro
// Login page with GitHub OAuth

import BaseLayout from "@layouts/BaseLayout.astro";
import { isAuthenticated, isOAuthConfigured } from "@lib/auth";
import { getAppDisplayName } from "../lib/app-config";
import { ArrowRight } from "lucide-react";

// If already authenticated, redirect to dashboard
if (isAuthenticated(Astro.cookies)) {
  return Astro.redirect("/");
}

const error = Astro.url.searchParams.get("error");
const errorMessages: Record<string, string> = {
  not_configured:
    "GitHub OAuth is not configured. Please set GITHUB_CLIENT_ID and GITHUB_CLIENT_SECRET.",
  access_denied:
    "Access denied. You are not authorized to access this admin panel.",
  auth_failed: "Authentication failed. Please try again.",
  no_code: "No authorization code received from GitHub.",
};

const errorMessage = error
  ? errorMessages[error] || "An error occurred. Please try again."
  : null;
const isConfigured = isOAuthConfigured();
const appDisplayName = getAppDisplayName();
---

<BaseLayout title="Login">
  <div class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-sm">
      <!-- Logo/Title -->
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-white mb-2">{appDisplayName}</h1>
        <p class="text-admin-muted">Sign in to manage your gallery</p>
      </div>

      <!-- Login Card -->
      <div class="card">
        {
          errorMessage && (
            <div class="mb-6 p-4 bg-red-500/10 border border-red-500/20 rounded-lg">
              <p class="text-red-400 text-sm">{errorMessage}</p>
            </div>
          )
        }

        {
          isConfigured ? (
            <a
              href="/auth/login"
              class="flex items-center justify-center gap-3 w-full py-3 px-4 bg-[#24292e] hover:bg-[#2f363d] text-white rounded-lg transition-colors"
            >
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path
                  fill-rule="evenodd"
                  d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"
                  clip-rule="evenodd"
                />
              </svg>
              <span class="font-medium">Sign in with GitHub</span>
            </a>
          ) : (
            <div class="text-center">
              <div class="mb-4 p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
                <p class="text-yellow-400 text-sm">
                  GitHub OAuth is not configured.
                </p>
              </div>
              <p class="text-admin-muted text-sm mb-4">
                To enable authentication, set the following environment
                variables:
              </p>
              <div class="bg-admin-sidebar p-3 rounded-lg text-left text-xs font-mono">
                <p class="text-green-400">GITHUB_CLIENT_ID=your_client_id</p>
                <p class="text-green-400">GITHUB_CLIENT_SECRET=your_secret</p>
                <p class="text-green-400">GITHUB_ALLOWED_USERS=your_username</p>
              </div>
            </div>
          )
        }

        <div class="mt-6 pt-6 border-t border-admin-border text-center">
          <p class="text-xs text-admin-muted">
            Need to create a GitHub OAuth App?
            <a
              href="https://github.com/settings/developers"
              target="_blank"
              rel="noopener"
              class="text-admin-accent hover:underline ml-1"
            >
              GitHub Developer Settings <ArrowRight
                className="w-3 h-3 ml-1 inline-block"
              />
            </a>
          </p>
        </div>
      </div>

      <!-- Footer -->
      <p class="text-center text-xs text-admin-muted mt-8">
        ArtSiteMaker â€¢ Portfolio CMS
      </p>
    </div>
  </div>
</BaseLayout>

<style>
  .card {
    background: var(--admin-sidebar, #1a1a1a);
    border: 1px solid var(--admin-border, #333);
    border-radius: 12px;
    padding: 24px;
  }
</style>

---
// packages/admin/src/pages/signup.astro
// Email/password signup page

import BaseLayout from "@layouts/BaseLayout.astro";
import {
  isAuthenticatedAsync,
} from "@lib/auth";
import { isEmailAuthConfigured } from "@lib/db-auth";
import { getAppDisplayName } from "../lib/app-config";
import { Eye, ArrowLeft } from "lucide-react";

const authCheck = await isAuthenticatedAsync(Astro.cookies);
if (authCheck.authenticated) {
  return Astro.redirect("/");
}

const isEmailConfigured = await isEmailAuthConfigured();

// Allow signup if the database is configured.
if (!isEmailConfigured) {
  const errorMsg = "Email authentication is not configured. Set DATABASE_URL environment variable.";
  return Astro.redirect(`/login?error=not_configured&message=${encodeURIComponent(errorMsg)}`);
}

const error = Astro.url.searchParams.get("error");
const errorMessageParam = Astro.url.searchParams.get("message");
const savedEmail = Astro.url.searchParams.get("email") || "";
const savedUsername = Astro.url.searchParams.get("username") || "";

const errorMessages: Record<string, string> = {
  missing_fields: "Please fill in all required fields.",
  invalid_email: "Please enter a valid email address.",
  weak_password: errorMessageParam || "Password does not meet requirements.",
  password_mismatch: "Passwords do not match.",
  signup_failed: errorMessageParam || "Failed to create account.",
};

const errorMessage = error ? errorMessages[error] || "An error occurred." : null;
const appDisplayName = getAppDisplayName();
---

<BaseLayout title="Sign Up">
  <div class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-sm">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-white mb-2">{appDisplayName}</h1>
        <p class="text-admin-muted">Create your account</p>
      </div>

      <div class="card">
        {errorMessage && (
          <div class="mb-6 p-4 bg-red-500/10 border border-red-500/20 rounded-lg">
            <p class="text-red-400 text-sm">{errorMessage}</p>
          </div>
        )}

        {isEmailConfigured ? (
          <form method="POST" action="/auth/email-signup" class="space-y-4">
            <div>
              <label for="email" class="block text-sm text-admin-muted mb-2">
                Email
              </label>
              <input
                type="email"
                id="email"
                name="email"
                value={savedEmail}
                class="w-full px-3 py-2 bg-admin-bg border border-admin-border rounded-lg text-white focus:outline-none focus:border-admin-accent"
                autocomplete="email"
                placeholder="you@example.com"
                required
              />
            </div>

            <div>
              <label for="username" class="block text-sm text-admin-muted mb-2">
                Display Name <span class="text-admin-muted/50">(optional)</span>
              </label>
              <input
                type="text"
                id="username"
                name="username"
                value={savedUsername}
                class="w-full px-3 py-2 bg-admin-bg border border-admin-border rounded-lg text-white focus:outline-none focus:border-admin-accent"
                autocomplete="name"
                placeholder="Your name"
              />
            </div>

            <div>
              <label for="password" class="block text-sm text-admin-muted mb-2">
                Password
              </label>
              <div class="relative">
                <input
                  type="password"
                  id="password"
                  name="password"
                  class="w-full px-3 py-2 bg-admin-bg border border-admin-border rounded-lg text-white focus:outline-none focus:border-admin-accent pr-10"
                  autocomplete="new-password"
                  placeholder="Min 8 chars, upper, lower, number"
                  aria-describedby="password-requirements"
                  required
                />
                <button
                  type="button"
                  class="absolute right-3 top-1/2 -translate-y-1/2 text-admin-muted hover:text-admin-main"
                  onclick="const i=document.getElementById('password');i.type=i.type==='password'?'text':'password'"
                >
                  <Eye className="w-4 h-4" />
                </button>
              </div>
              <div
                id="password-requirements"
                class="mt-2 text-xs"
                aria-live="polite"
                aria-atomic="true"
              >
                <ul class="mt-2 space-y-1">
                  <li
                    data-rule="length"
                    class="hidden items-center justify-between text-green-400"
                  >
                    <span class="flex items-center gap-2">
                      <span data-icon aria-hidden="true" class="text-xs">✓</span>
                      <span>At least 8 characters</span>
                    </span>
                  </li>
                  <li
                    data-rule="uppercase"
                    class="hidden items-center justify-between text-green-400"
                  >
                    <span class="flex items-center gap-2">
                      <span data-icon aria-hidden="true" class="text-xs">✓</span>
                      <span>Uppercase letter (A–Z)</span>
                    </span>
                  </li>
                  <li
                    data-rule="lowercase"
                    class="hidden items-center justify-between text-green-400"
                  >
                    <span class="flex items-center gap-2">
                      <span data-icon aria-hidden="true" class="text-xs">✓</span>
                      <span>Lowercase letter (a–z)</span>
                    </span>
                  </li>
                  <li
                    data-rule="number"
                    class="hidden items-center justify-between text-green-400"
                  >
                    <span class="flex items-center gap-2">
                      <span data-icon aria-hidden="true" class="text-xs">✓</span>
                      <span>Number (0–9)</span>
                    </span>
                  </li>
                </ul>
              </div>
            </div>

            <div>
              <label for="confirmPassword" class="block text-sm text-admin-muted mb-2">
                Confirm Password
              </label>
              <input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                class="w-full px-3 py-2 bg-admin-bg border border-admin-border rounded-lg text-white focus:outline-none focus:border-admin-accent"
                autocomplete="new-password"
                placeholder="Re-enter password"
                required
              />
            </div>

            <div class="mt-6">
              <button
                type="submit"
                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-admin-accent hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-admin-accent transition-colors"
              >
                Create Account
              </button>
            </div>
          </form>
        ) : (
          <div class="text-center">
            <div class="mb-4 p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
              <p class="text-yellow-400 text-sm">
                Email authentication is not configured.
              </p>
            </div>
            <p class="text-admin-muted text-sm">
              Set the <code class="bg-admin-bg px-1 rounded">DATABASE_URL</code> environment variable to enable email signup.
            </p>
          </div>
        )}

        <div class="mt-6 pt-6 border-t border-admin-border text-center">
          <a
            href="/login"
            class="text-sm text-admin-muted hover:text-admin-accent inline-flex items-center gap-1"
          >
            <ArrowLeft className="w-4 h-4" />
            Already have an account? Sign in
          </a>
        </div>
      </div>

      <p class="text-center text-xs text-admin-muted mt-8">
        ArtSiteMaker • Portfolio CMS
      </p>
    </div>
  </div>
</BaseLayout>

<script is:inline>
  const passwordInput = document.getElementById('password');
  const requirements = document.getElementById('password-requirements');

  if (passwordInput && requirements) {
    const rules = [
      { id: 'length', test: (value) => value.length >= 8 },
      { id: 'uppercase', test: (value) => /[A-Z]/.test(value) },
      { id: 'lowercase', test: (value) => /[a-z]/.test(value) },
      { id: 'number', test: (value) => /[0-9]/.test(value) },
    ];

    const updateRule = (rule, valid) => {
      const item = requirements.querySelector(`[data-rule="${rule.id}"]`);
      if (!item) return;
      const icon = item.querySelector('[data-icon]');

      item.classList.toggle('hidden', !valid);

      if (icon) icon.textContent = '✓';
    };

    const updateRequirements = () => {
      const value = passwordInput.value || '';
      rules.forEach((rule) => updateRule(rule, rule.test(value)));
    };

    updateRequirements();
    passwordInput.addEventListener('input', updateRequirements);
  }
</script>

<style>
  .card {
    background: var(--admin-sidebar, #1a1a1a);
    border: 1px solid var(--admin-border, #333);
    border-radius: 12px;
    padding: 24px;
  }
</style>
